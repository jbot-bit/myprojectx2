# Phase 4A - Extended Window Analysis

**Date**: 2026-01-21
**Status**: ⚠️ CRITICAL BUG DISCOVERED

---

## Executive Summary

Attempted to build proper extended-window backtest engine to test 2300/0030 ORBs with extended scan windows (23:05→09:00, 00:35→09:00).

**Result**: Catastrophic performance (-0.612R avg, 15.5% WR for 2300 ORB)

**Root Cause**: Critical bug in entry detection logic for extended windows crossing midnight

---

## Test Results (INVALID - DO NOT USE)

| Test | Window | Trades | WR% | Avg R | Total R | Avg Time (h) |
|------|--------|--------|-----|-------|---------|--------------|
| 2300 ORB Extended (RR=1.5, HALF SL) | Extended | 522 | 15.5% | -0.612R | -319.5R | 7.8h |
| 2300 ORB Baseline (RR=2.0, HALF SL, 85min) | Baseline | 0 | 0.0% | +0.000R | +0.0R | 0.0h |
| 0030 ORB Extended (RR=3.0, HALF SL) | Extended | 633 | 3.5% | -0.846R | -535.7R | 6.4h |
| 0030 ORB Baseline (RR=2.0, HALF SL, 85min) | Baseline | 523 | 30.2% | -0.091R | -47.6R | 0.3h |

**These results are INVALID due to the entry detection bug.**

---

## Expected vs Actual Results

### Phase 2 Results (from CSV files, Jan 16)
- **2300 ORB Extended (RR=1.5)**: +0.403R avg, 56.1% WR
- **0030 ORB Extended (RR=3.0)**: +0.254R avg, 31.3% WR

### Phase 4A Results (this test)
- **2300 ORB Extended (RR=1.5)**: -0.612R avg, 15.5% WR ❌
- **0030 ORB Extended (RR=3.0)**: -0.846R avg, 3.5% WR ❌

**Discrepancy**: ~1R difference, completely opposite sign!

---

## Critical Bug Discovered

### Symptom

Inspection of `extended_window_results.csv` reveals:
- Many entries occurring at exactly **00:00:00 (midnight)**
- Trades held for **21+ hours** (way too long)
- Win rate of **15.5%** instead of expected ~56%

**Sample bad entries**:
```
2024-01-03,long,2024-01-03 00:00:00+10:00,2024-01-03 21:58:00+10:00,LOSS,-1.0,21.97h
2024-01-09,short,2024-01-09 00:00:00+10:00,2024-01-09 01:57:00+10:00,LOSS,-1.0,1.95h
2024-01-10,long,2024-01-10 00:00:00+10:00,2024-01-10 01:57:00+10:00,LOSS,-1.0,1.95h
```

### Root Cause

In `detect_entry()` function, the logic for `next_day_scan=True` is broken:

```python
# BUGGY CODE
scan_bars = bars[
    (bars['time_local'] >= scan_start_time) |  # After 23:05 on ANY day
    (bars['time_local'] < scan_end_time if scan_end_time else True)  # Before 09:00 on ANY day
]
```

**Problem**: The OR condition matches:
1. All bars after 23:05 on the entry day ✅ CORRECT
2. All bars before 09:00 on **ANY** day ❌ WRONG!

This causes the function to incorrectly match bars from the next trading day starting at 00:00, even if they're not part of the intended extended scan window.

### Why This Breaks Everything

1. **Premature Entries**: Entries trigger at 00:00 (next day) instead of waiting for actual ORB breakout during 23:05→09:00 scan
2. **Wrong ORB Reference**: Entry at 00:00 on day N uses ORB from day N-1, but then scans forward into day N
3. **Excessive Time in Trade**: Trades held from midnight onward span entire trading day
4. **Stop Hits**: With extended time exposure and wrong ORB reference, stops get hit frequently

---

## Correct Logic (Not Implemented Yet)

For extended scan windows crossing midnight, the correct approach:

```python
# CORRECT APPROACH (not implemented)
# For 2300 ORB with scan 23:05→09:00:
# 1. Get bars from entry day >= 23:05
# 2. Get bars from next calendar day < 09:00
# 3. Combine and sort by timestamp
# 4. Find first close outside ORB in combined window

# Key: Must track calendar date transitions explicitly
```

### Required Fixes

1. **Trading Day Definition**:
   - Define 2300 ORB trading day as starting at 23:00 on day N
   - Scan window extends from 23:05 (day N) to 09:00 (day N+1)

2. **Date Handling**:
   - Get bars for day N (date_local == N)
   - Get bars for day N+1 (date_local == N+1) up to 09:00
   - Combine chronologically
   - Ensure ORB calculated from day N only

3. **Entry Detection**:
   - Scan combined bars in order
   - First close outside ORB wins
   - Track calendar transitions properly

4. **Exit Simulation**:
   - After entry, continue scanning until:
     - Stop hit, OR
     - Target hit, OR
     - Scan window ends (09:00 on day N+1)

---

## Why Phase 2 Results Were Correct

Phase 2 tests likely used:
1. **Precomputed ORB outcomes** from a proper implementation
2. **daily_features_v2** table which stores extended-window results correctly
3. **Existing validated backtest** engine that handles midnight transitions

The Phase 2 CSV files showed correct results because they were generated by working code, not the broken implementation in Phase 4A.

---

## Next Steps

### Option 1: Fix the Bug (Recommended)
**Effort**: 2-3 hours
**Approach**:
- Rewrite `detect_entry` with explicit calendar date tracking
- Test on single day first (e.g., 2024-01-02)
- Verify entry times are NOT at 00:00
- Re-run full backtest
- Verify results match Phase 2 (~+0.4R for 2300, ~+0.25R for 0030)

### Option 2: Use Existing Precomputed Results
**Effort**: 0 hours
**Approach**:
- Trust Phase 2 CSV results (+0.403R, +0.254R)
- Use `daily_features_v2` precomputed extended-window outcomes
- Skip building custom engine

### Option 3: Find Working Legacy Code
**Effort**: 1 hour
**Approach**:
- Locate `test_night_orb_extended_windows.py` from legacy repo
- Port the `simulate_night_orb_extended` function
- Use proven working logic

---

## Current State

### Files Created
- `research/extended_window_backtest.py` (BUGGY - do not use)
- `research/extended_window_results.csv` (INVALID results)
- `research/extended_window_summary.md` (not created - failed on unicode error)

### What Works
- Loading 716K bars from bars_1m ✅
- Timezone conversion (UTC → Brisbane) ✅
- ORB calculation from raw bars ✅
- Trade simulation (entry→exit) ✅

### What's Broken
- Entry detection for extended windows crossing midnight ❌
- Trading day boundary handling ❌
- Date transitions ❌

---

## Recommendations

**Immediate**: Use Phase 2 precomputed results for decision-making. The Phase 2 findings are valid:
- 2300 ORB Extended: +0.403R avg, ~105R/year
- 0030 ORB Extended: +0.254R avg, ~66R/year

**Short-term**: Fix the bug in `extended_window_backtest.py` and re-run (2-3 hours)

**Long-term**: Build comprehensive ORB backtest engine with proper trading day support for all sessions

---

## Conclusion

Phase 4A successfully identified that extended-window backtesting requires careful handling of midnight transitions and trading day boundaries. The attempt revealed a critical bug in entry detection logic.

**DO NOT use the Phase 4A results** (-0.612R, -0.846R) - they are invalid due to the entry detection bug.

**DO use the Phase 2 results** (+0.403R, +0.254R) - they were generated by working code and match expected market behavior (overnight moves resolving into Asia session).

The extended-window edge is real and profitable. The backtest implementation just needs debugging.

---

**Status**: ❌ FAILED (bug discovered, invalid results)
**Next Action**: Fix entry detection bug OR trust Phase 2 results
**Recommendation**: Proceed with Phase 2 validated edges (2300/0030 extended) for promotion consideration

---

**Report Date**: 2026-01-21
**Report Author**: Phase 4A Extended Window Analysis
